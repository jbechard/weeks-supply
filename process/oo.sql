SET NOCOUNT ON
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED

SELECT
  pm.PROD_NO as ITEM, 
  CASE WHEN db.PERIOD_ID - pyr.PERIOD_END_ID < 1 THEN 1 ELSE (db.PERIOD_ID - pyr.PERIOD_END_ID) + 1 END as RelWk,
  db.DEMAND_VALUE as OrderQuantity
FROM DP_PROD.DEMAND_BUCKET db
INNER JOIN DP_PROD.DEMAND_ENTITY de ON de.DEMAND_ENTITY_ID=db.DEMAND_ENTITY_ID
INNER JOIN DP_PROD.PROD_MSTR pm ON pm.PROD_ID=de.PROD_ID
CROSS JOIN (SELECT PERIOD_END_ID FROM DP_PROD.PYRAMID_MSTR WHERE PYRAMID_ID=1) pyr
WHERE db.DEMAND_TYPE_CD = 2 AND db.DEMAND_VALUE > 0




SELECT *
FROM (
  SELECT 
    RTRIM(oo.ITEM) as ITEM, 
    CASE WHEN DATEDIFF(wk,GETDATE(),PlanDeliveryDate) < 1 THEN 1 ELSE DATEDIFF(wk,GETDATE(),PlanDeliveryDate) + 1 END as RelWk,
    OrderQuantity
  FROM OpenOrders oo 
  JOIN ITEM im ON im.ITEM=oo.ITEM
  JOIN CUSTOMER_HIERARCHY_EXT ch ON ch.CUSTOMER=oo.Customer
  WHERE OrderQuantity > 0 AND 
    [item_grp] IN(301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,389,390) AND
    (
    OrderType IN ('110','111','112','113','115','120','121','122','123','125','130','131','132','133','135','140','141','142','143','145','150','151','152','160','161','162','163','170','171','172','173','175','180','181','182','183','190','191','192','193','194','196','630','660','661','662','664') 
    OR
      (
        OrderType IN ('195','650','110','111','112','113','115','120','121','122','123','125','130','131','132','133','135','140','141','142','143','145','150','151','152','160','161','162','163','170','171','172','173','175','180','181','182','183','190','191','192','193','194','196','630','660','661','662','664') AND
        ch.FCST_CUST_GRP = 'ROSS'
      )
    )
) AS t
PIVOT (  
  SUM(OrderQuantity)
  FOR RelWk IN ([1],[2],[3],[4],[5],[6],[7],[8],[9],[10],[11],[12],[13],[14],[15],[16],[17],[18],[19],[20],[21],[22],[23],[24],[25],[26],[27],[28],[29],[30],[31],[32],[33],[34],[35],[36],[37],[38],[39],[40],[41],[42],[43],[44],[45],[46],[47],[48],[49],[50],[51],[52])
) AS pvt
ORDER BY ITEM